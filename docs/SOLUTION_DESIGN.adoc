= Technical Solution Design - Zapdesk
KnowAll AI - Zendesk Lightning Network Tipping Application
:doctype: book
:toc: left
:toclevels: 2
:sectlinks:
:sectanchors:
:sectnums!:
:chapter-signifier:
:source-highlighter: coderay
:icons: font
:imagesdir: images
:pdf-fontsdir: fonts
:pdf-font: Calibri

include::TERMS.adoc[]

include::CONFIDENTIALITY.adoc[]

== Document History

[cols="1,2,1,3",options="header"]
|===
|Version |Date |Author |Changes
|1.0 |2025-10-22 |KnowAll AI |Initial solution design document created for Zapdesk Lightning Network tipping application
|1.1 |2025-10-22 |Akash Jadhav |Updated document structure to follow professional technical design standards with enhanced formatting and organization
|===

:sectnums:

== Overview
Zapdesk is a ZAF sidebar app enabling users to tip agents over the Bitcoin Lightning Network. The MVP is client-only, wallet-agnostic, and supports:

* **Lightning Network Integration**: Send tips using Lightning addresses configured in agent profiles
* **QR Code Generation**: Display QR codes for easy mobile wallet scanning
* **Custom Tip Amounts**: Support for predefined and custom tip amounts
* **Configurable Comment Visibility**: Admin setting to control whether tip comments are public or private
* **LNURL Support**: Full LNURL protocol implementation for Lightning payments
* **Service Layer Architecture**: Clean separation of concerns with dedicated services for Zendesk and Lightning operations

== Architecture

[cols="1,3"]
|===
| Component | Description

| ZAF React App
| Packaged (iframe) React + TypeScript + Vite build to `/assets`. Uses ZAF SDK (`ZAFClient`) to read context and post to the ticket.

| Agent Mapping
| Resolve agent Lightning Address from a Zendesk **user custom field** (configurable key). Optional fallback address.

| Payment – QR / LNURL
| Render QR + copyable string for the selected preset amount using LNURL-pay or BOLT11 as provided/configured.

| End-User Message
| Short text input bound to the payment memo (NWC). Always appended to the ticket post after success.

| Ticket Posting
| After success, app posts a message to the ticket via ZAF (visibility = `public` or `internal`, from settings). Contains amount, agent target, and the user message.
|===

== Key Flows

=== Tip via QR / LNURL-pay
. App loads; determines target agent and payout address.
. User enters an optional message; selects a preset.
. App displays QR + copyable payment string.
. User pays with their wallet.
. User clicks “I’ve paid” (manual acknowledge) → app posts to ticket with the message.

== UI

* Header with branding.
* Agent context (avatar/name) + payout destination (masked).
* Message textarea (limit, e.g., 140 chars).
* Preset buttons (100 / 1,000 / 10,000 sats; configurable).
* Actions: **Tip by QR**, **Connect wallet (NWC)** / **Tip now**.
* Status banners; copy helpers; balance indicator (NWC).

== ZAF Integration

* `client.get(['ticket.id', 'ticket.assignee', 'currentUser'])`
* Post to ticket:
** Public reply append: `client.invoke('comment.appendText', msg)` then agent/end-user sends
** or direct API call via `client.request()` to create a comment (visibility from settings)
* Settings read via `client.metadata()` / app settings API.

== Settings

* `presets`: hardcoded sats amounts (e.g., `100,1000,10000`)
* `agentLightningFieldKey`: string (e.g., `user.custom_fields.lightning_address`)
* `fallbackLightningAddress`: string (optional)
* `postVisibility`: enum `public`|`internal`
* `brandingTitle` / `brandingDescription` (optional)

== Security

* All code runs inside the ZAF iframe sandbox.
* No custody; payments occur in the end-user’s wallet.
* Respect CSP (Content Security Policy); avoid unnecessary external scripts.

== Build & Packaging

* React + Vite + TypeScript → `/assets`: `iframe.html`, `app.js`, `app.css`
* `manifest.json` points `support.ticket_sidebar` → `assets/iframe.html`
* `zcli apps:package` to produce distributable zip

include::TESTING.adoc[]

include::DEPLOYMENTS.adoc[]

[appendix]
include::TROUBLESHOOTING.adoc[]

[appendix]
include::FAQS.adoc[]

[appendix]
include::CONTACTS.adoc[]
